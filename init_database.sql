-- Скрипт для инициализации базы данных booBook
-- Создает функции, заполняет тестовыми данными и добавляет историю для пользователей Keycloak

-- ============================================
-- 1. СОЗДАНИЕ ФУНКЦИЙ
-- ============================================

-- Удаляем старую функцию, если существует
DROP FUNCTION IF EXISTS get_average_book_rating(BIGINT);

-- Функция для вычисления среднего рейтинга книги
CREATE FUNCTION get_average_book_rating(p_book_id BIGINT)
RETURNS FLOAT AS $$
DECLARE
    avg_rating FLOAT;
BEGIN
    SELECT COALESCE(AVG(r.rating_value), 0.0)
    INTO avg_rating
    FROM rating r
    WHERE r.book_id = p_book_id;
    
    RETURN COALESCE(avg_rating, 0.0);
END;
$$ LANGUAGE plpgsql;

-- Комментарий к функции
COMMENT ON FUNCTION get_average_book_rating(BIGINT) IS 'Вычисляет средний рейтинг книги по всем оценкам';

-- ============================================
-- 2. ЗАПОЛНЕНИЕ ТЕСТОВЫМИ ДАННЫМИ
-- ============================================

-- ЖАНРЫ (Genre) - 10 записей
INSERT INTO genre (name, popularity) VALUES
('Фантастика', 95),
('Детектив', 88),
('Роман', 92),
('Научная литература', 75),
('Историческая проза', 80),
('Поэзия', 70),
('Детская литература', 85),
('Триллер', 82),
('Фэнтези', 90),
('Биография', 78)
ON CONFLICT (name) DO NOTHING;

-- ТЕМЫ (Theme) - 10 записей
INSERT INTO theme (name, popularity) VALUES
('Любовь', 90),
('Приключения', 88),
('Война', 75),
('Дружба', 85),
('Семья', 87),
('Путешествия', 80),
('Мистика', 78),
('Философия', 72),
('Природа', 70),
('Технологии', 85)
ON CONFLICT (name) DO NOTHING;

-- ИЗДАТЕЛЬСТВА (Publisher) - 10 записей
INSERT INTO publisher (name, website, email) VALUES
('АСТ', 'https://ast.ru', 'info@ast.ru'),
('Эксмо', 'https://eksmo.ru', 'info@eksmo.ru'),
('Манн, Иванов и Фербер', 'https://mann-ivanov-ferber.ru', 'info@mann-ivanov-ferber.ru'),
('Альпина Паблишер', 'https://alpinabook.ru', 'info@alpinabook.ru'),
('Росмэн', 'https://rosman.ru', 'info@rosman.ru'),
('Питер', 'https://piter.com', 'info@piter.com'),
('ОЛМА Медиа Групп', 'https://olmamedia.ru', 'info@olmamedia.ru'),
('Азбука', 'https://azbooka.ru', 'info@azbooka.ru'),
('Центрполиграф', 'https://centrpoligraf.ru', 'info@centrpoligraf.ru'),
('Молодая гвардия', 'https://gvardiya.ru', 'info@gvardiya.ru')
ON CONFLICT (name) DO NOTHING;

-- БИБЛИОТЕКИ (Library) - 3 записи
INSERT INTO library (name, address, opening_time, closing_time) VALUES
('Центральная библиотека им. Пушкина', 'г. Москва, ул. Тверская, д. 10', '09:00:00', '20:00:00'),
('Библиотека им. Лермонтова', 'г. Санкт-Петербург, Невский пр., д. 20', '10:00:00', '19:00:00'),
('Городская библиотека №1', 'г. Казань, ул. Баумана, д. 5', '08:00:00', '18:00:00')
ON CONFLICT DO NOTHING;

-- АВТОРЫ (Author) - 15 записей
INSERT INTO author (name, surname, birth_date) VALUES
('Лев', 'Толстой', '1828-09-09'),
('Фёдор', 'Достоевский', '1821-11-11'),
('Александр', 'Пушкин', '1799-06-06'),
('Антон', 'Чехов', '1860-01-29'),
('Иван', 'Тургенев', '1818-11-09'),
('Николай', 'Гоголь', '1809-04-01'),
('Михаил', 'Булгаков', '1891-05-15'),
('Александр', 'Солженицын', '1918-12-11'),
('Борис', 'Пастернак', '1890-02-10'),
('Владимир', 'Набоков', '1899-04-22'),
('Джордж', 'Оруэлл', '1903-06-25'),
('Рэй', 'Брэдбери', '1920-08-22'),
('Агата', 'Кристи', '1890-09-15'),
('Стивен', 'Кинг', '1947-09-21'),
('Джоан', 'Роулинг', '1965-07-31')
ON CONFLICT DO NOTHING;

-- КНИГИ (Book) - 50 записей
INSERT INTO book (title, year_published, isbn, genre_id, publisher_id, theme_id) VALUES
-- Классическая литература
('Война и мир', 1869, '978-5-17-123456-1', 3, 1, 3),
('Преступление и наказание', 1866, '978-5-17-123456-2', 3, 1, 4),
('Евгений Онегин', 1833, '978-5-17-123456-3', 6, 2, 1),
('Анна Каренина', 1877, '978-5-17-123456-4', 3, 1, 1),
('Братья Карамазовы', 1880, '978-5-17-123456-5', 3, 1, 4),
('Идиот', 1869, '978-5-17-123456-6', 3, 1, 4),
('Вишнёвый сад', 1904, '978-5-17-123456-7', 3, 2, 5),
('Отцы и дети', 1862, '978-5-17-123456-8', 3, 1, 5),
('Мёртвые души', 1842, '978-5-17-123456-9', 3, 2, 4),
('Мастер и Маргарита', 1967, '978-5-17-123456-10', 1, 1, 7),
-- Фантастика и фэнтези
('1984', 1949, '978-5-17-123456-11', 1, 3, 8),
('451 градус по Фаренгейту', 1953, '978-5-17-123456-12', 1, 3, 9),
('Гарри Поттер и философский камень', 1997, '978-5-17-123456-13', 9, 4, 2),
('Гарри Поттер и Тайная комната', 1998, '978-5-17-123456-14', 9, 4, 2),
('Гарри Поттер и узник Азкабана', 1999, '978-5-17-123456-15', 9, 4, 2),
('Властелин колец: Братство кольца', 1954, '978-5-17-123456-16', 9, 5, 2),
('Властелин колец: Две крепости', 1954, '978-5-17-123456-17', 9, 5, 2),
('Властелин колец: Возвращение короля', 1955, '978-5-17-123456-18', 9, 5, 2),
('Дюна', 1965, '978-5-17-123456-19', 1, 6, 2),
('Марсианин', 2011, '978-5-17-123456-20', 1, 3, 2),
-- Детективы и триллеры
('Убийство в Восточном экспрессе', 1934, '978-5-17-123456-21', 2, 7, 4),
('Десять негритят', 1939, '978-5-17-123456-22', 2, 7, 4),
('Сияние', 1977, '978-5-17-123456-23', 8, 8, 7),
('Оно', 1986, '978-5-17-123456-24', 8, 8, 7),
('Зелёная миля', 1996, '978-5-17-123456-25', 8, 8, 4),
('Шерлок Холмс: Этюд в багровых тонах', 1887, '978-5-17-123456-26', 2, 9, 4),
('Шерлок Холмс: Знак четырёх', 1890, '978-5-17-123456-27', 2, 9, 4),
('Девушка с татуировкой дракона', 2005, '978-5-17-123456-28', 2, 10, 4),
('Исчезнувшая', 2012, '978-5-17-123456-29', 8, 1, 4),
('Тихий омут', 2015, '978-5-17-123456-30', 2, 2, 4),
-- Научная и историческая литература
('Краткая история времени', 1988, '978-5-17-123456-31', 4, 3, 8),
('Сапиенс: Краткая история человечества', 2011, '978-5-17-123456-32', 4, 3, 8),
('Архипелаг ГУЛАГ', 1973, '978-5-17-123456-33', 5, 1, 3),
('Доктор Живаго', 1957, '978-5-17-123456-34', 3, 1, 3),
('Лолита', 1955, '978-5-17-123456-35', 3, 2, 1),
('Один день Ивана Денисовича', 1962, '978-5-17-123456-36', 5, 1, 3),
('История России', 2015, '978-5-17-123456-37', 5, 4, 3),
('Вторая мировая война', 1948, '978-5-17-123456-38', 5, 5, 3),
('История Древнего мира', 2010, '978-5-17-123456-39', 5, 6, 3),
('Великие географические открытия', 2012, '978-5-17-123456-40', 4, 7, 6),
-- Детская литература
('Приключения Тома Сойера', 1876, '978-5-17-123456-41', 7, 5, 2),
('Алиса в Стране чудес', 1865, '978-5-17-123456-42', 7, 5, 2),
('Винни-Пух и все-все-все', 1926, '978-5-17-123456-43', 7, 5, 4),
('Маленький принц', 1943, '978-5-17-123456-44', 7, 8, 4),
('Гарри Поттер и Кубок огня', 2000, '978-5-17-123456-45', 9, 4, 2),
('Гарри Поттер и Орден Феникса', 2003, '978-5-17-123456-46', 9, 4, 2),
('Гарри Поттер и Принц-полукровка', 2005, '978-5-17-123456-47', 9, 4, 2),
('Гарри Поттер и Дары Смерти', 2007, '978-5-17-123456-48', 9, 4, 2),
('Хоббит, или Туда и обратно', 1937, '978-5-17-123456-49', 9, 5, 2),
('Незнайка на Луне', 1965, '978-5-17-123456-50', 7, 5, 2)
ON CONFLICT DO NOTHING;

-- СВЯЗЬ АВТОРОВ И КНИГ (author_books) - Many-to-Many
INSERT INTO author_books (book_id, author_id) VALUES
-- Толстой
(1, 1), (4, 1),
-- Достоевский
(2, 2), (5, 2), (6, 2),
-- Пушкин
(3, 3),
-- Чехов
(7, 4),
-- Тургенев
(8, 5),
-- Гоголь
(9, 6),
-- Булгаков
(10, 7),
-- Оруэлл
(11, 11),
-- Брэдбери
(12, 12),
-- Роулинг
(13, 15), (14, 15), (15, 15), (45, 15), (46, 15), (47, 15), (48, 15),
-- Кристи
(21, 13), (22, 13),
-- Кинг
(23, 14), (24, 14), (25, 14),
-- Солженицын
(33, 8), (36, 8),
-- Пастернак
(34, 9),
-- Набоков
(35, 10)
ON CONFLICT DO NOTHING;

-- КОПИИ КНИГ (book_copy) - 80 записей
INSERT INTO book_copy (book_id, library_id, inventory_number, available) VALUES
-- Война и мир (3 копии)
(1, 1, 'INV-001-001', true),
(1, 2, 'INV-001-002', true),
(1, 3, 'INV-001-003', false),
-- Преступление и наказание (2 копии)
(2, 1, 'INV-002-001', true),
(2, 1, 'INV-002-002', true),
-- Евгений Онегин (2 копии)
(3, 1, 'INV-003-001', true),
(3, 2, 'INV-003-002', true),
-- Анна Каренина (3 копии)
(4, 1, 'INV-004-001', true),
(4, 2, 'INV-004-002', false),
(4, 3, 'INV-004-003', true),
-- Братья Карамазовы (2 копии)
(5, 1, 'INV-005-001', true),
(5, 1, 'INV-005-002', true),
-- Идиот (1 копия)
(6, 2, 'INV-006-001', true),
-- Вишнёвый сад (2 копии)
(7, 1, 'INV-007-001', true),
(7, 3, 'INV-007-002', true),
-- Отцы и дети (2 копии)
(8, 1, 'INV-008-001', false),
(8, 2, 'INV-008-002', true),
-- Мёртвые души (1 копия)
(9, 1, 'INV-009-001', true),
-- Мастер и Маргарита (3 копии)
(10, 1, 'INV-010-001', true),
(10, 2, 'INV-010-002', true),
(10, 3, 'INV-010-003', false),
-- 1984 (2 копии)
(11, 1, 'INV-011-001', true),
(11, 1, 'INV-011-002', true),
-- 451 градус (2 копии)
(12, 1, 'INV-012-001', true),
(12, 2, 'INV-012-002', true),
-- Гарри Поттер 1-3 (по 2 копии каждая)
(13, 3, 'INV-013-001', true),
(13, 3, 'INV-013-002', false),
(14, 3, 'INV-014-001', true),
(14, 3, 'INV-014-002', true),
(15, 3, 'INV-015-001', true),
(15, 3, 'INV-015-002', true),
-- Властелин колец (по 2 копии)
(16, 1, 'INV-016-001', true),
(16, 2, 'INV-016-002', true),
(17, 1, 'INV-017-001', true),
(17, 2, 'INV-017-002', false),
(18, 1, 'INV-018-001', true),
(18, 2, 'INV-018-002', true),
-- Дюна (1 копия)
(19, 1, 'INV-019-001', true),
-- Марсианин (2 копии)
(20, 1, 'INV-020-001', true),
(20, 1, 'INV-020-002', true),
-- Детективы (по 2 копии)
(21, 1, 'INV-021-001', true),
(21, 2, 'INV-021-002', true),
(22, 1, 'INV-022-001', true),
(22, 2, 'INV-022-002', false),
(23, 1, 'INV-023-001', true),
(23, 3, 'INV-023-002', true),
(24, 1, 'INV-024-001', true),
(24, 3, 'INV-024-002', true),
(25, 1, 'INV-025-001', true),
(25, 2, 'INV-025-002', true),
(26, 1, 'INV-026-001', true),
(26, 2, 'INV-026-002', true),
(27, 1, 'INV-027-001', true),
(27, 2, 'INV-027-002', true),
(28, 1, 'INV-028-001', false),
(28, 2, 'INV-028-002', true),
(29, 1, 'INV-029-001', true),
(29, 3, 'INV-029-002', true),
(30, 1, 'INV-030-001', true),
(30, 2, 'INV-030-002', true),
-- Научная литература (по 1-2 копии)
(31, 2, 'INV-031-001', true),
(32, 2, 'INV-032-001', true),
(33, 1, 'INV-033-001', true),
(33, 2, 'INV-033-002', true),
(34, 1, 'INV-034-001', true),
(35, 1, 'INV-035-001', true),
(36, 1, 'INV-036-001', true),
(37, 2, 'INV-037-001', true),
(38, 2, 'INV-038-001', true),
(39, 2, 'INV-039-001', true),
(40, 2, 'INV-040-001', true),
-- Детская литература (по 2-3 копии)
(41, 3, 'INV-041-001', true),
(41, 3, 'INV-041-002', true),
(42, 3, 'INV-042-001', true),
(42, 3, 'INV-042-002', true),
(43, 3, 'INV-043-001', true),
(43, 3, 'INV-043-002', true),
(44, 3, 'INV-044-001', true),
(45, 3, 'INV-045-001', true),
(45, 3, 'INV-045-002', true),
(46, 3, 'INV-046-001', true),
(46, 3, 'INV-046-002', true),
(47, 3, 'INV-047-001', true),
(47, 3, 'INV-047-002', true),
(48, 3, 'INV-048-001', true),
(48, 3, 'INV-048-002', true),
(49, 3, 'INV-049-001', true),
(49, 3, 'INV-049-002', true),
(50, 3, 'INV-050-001', true),
(50, 3, 'INV-050-002', true)
ON CONFLICT DO NOTHING;

-- РЕЙТИНГИ (rating) - 20 записей
INSERT INTO rating (user_id, email, book_id, rating_value, review, time) VALUES
('user-001', 'user1@example.com', 1, 5, 'Великолепное произведение! Обязательно к прочтению.', '2024-12-01 18:00:00'),
('user-002', 'user2@example.com', 2, 5, 'Глубокий психологический роман. Потрясающе!', '2024-12-05 20:00:00'),
('user-003', 'user3@example.com', 10, 5, 'Одна из лучших книг, которые я читал. Мастерство Булгакова на высоте.', '2024-12-08 19:30:00'),
('user-004', 'user4@example.com', 11, 5, 'Актуально и по сей день. Обязательно прочитайте!', '2024-12-10 21:00:00'),
('user-005', 'user5@example.com', 12, 4, 'Интересная антиутопия, но немного устарела.', '2024-12-12 17:00:00'),
('user-006', 'user6@example.com', 13, 5, 'Отличная книга для детей и взрослых!', '2024-11-30 16:00:00'),
('user-007', 'user7@example.com', 4, 4, 'Классика русской литературы. Рекомендую.', '2024-12-05 15:00:00'),
('user-008', 'user8@example.com', 10, 5, 'Перечитываю уже третий раз. Гениально!', '2024-12-10 18:00:00'),
('user-009', 'user9@example.com', 14, 5, 'Продолжение не разочаровало. Жду следующую книгу!', '2024-12-15 19:00:00'),
('user-010', 'user10@example.com', 21, 4, 'Хороший детектив, но концовка предсказуема.', '2024-12-18 20:00:00'),
('user-011', 'user11@example.com', 1, 5, 'Монументальное произведение. Читал месяц, но оно того стоило.', '2024-10-20 16:00:00'),
('user-012', 'user12@example.com', 5, 4, 'Сложная, но интересная книга. Философские размышления на высоте.', '2024-10-25 17:00:00'),
('user-013', 'user13@example.com', 7, 3, 'Не мой жанр, но написано хорошо.', '2024-10-30 18:00:00'),
('user-014', 'user14@example.com', 15, 5, 'Любимая книга детства. Перечитываю с удовольствием.', '2024-11-05 19:00:00'),
('user-015', 'user15@example.com', 20, 4, 'Захватывающий научно-фантастический роман.', '2024-11-10 20:00:00'),
('user-016', 'user16@example.com', 16, 5, 'Эпическая сага. Начало великой трилогии.', '2024-11-15 21:00:00'),
('user-017', 'user17@example.com', 23, 4, 'Страшная, но интересная книга. Кинг как всегда на высоте.', '2024-11-20 22:00:00'),
('user-018', 'user18@example.com', 31, 5, 'Отличное введение в космологию. Понятно даже для новичков.', '2024-11-25 18:00:00'),
('user-019', 'user19@example.com', 41, 4, 'Классика детской литературы. Всем детям к прочтению!', '2024-11-30 19:00:00'),
('user-020', 'user20@example.com', 44, 5, 'Философская сказка для всех возрастов. Гениально просто.', '2024-12-05 20:00:00')
ON CONFLICT DO NOTHING;
